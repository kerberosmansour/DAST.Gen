# Deserialization of Untrusted Data (CWE-502) in Java

###### Understanding Deserialization of Untrusted Data

Deserialization of untrusted data is a vulnerability that occurs when data from an untrusted source is deserialized without proper validation or sanitization. In Java, this can lead to arbitrary code execution, attacks on application integrity, or exposure of sensitive data.

### Variations of Deserialization in Java Web Applications

Deserialization vulnerabilities in Java applications can occur in various contexts, including:
1. **Standard Java Serialization**: Use of `java.io.ObjectInputStream` to deserialize objects.
2. **Serialized Data in HTTP Requests**: Handling user-supplied serialized objects in HTTP requests.
3. **Popular Frameworks**:
   - **Spring**: Handling of serialized data in the session or HTTP requests.
   - **Apache Struts**: Using object representations for form data.
   - **Hibernate**: Usage of deserialization for complex queries or object serialization.

### Writing ZAP Zest Scripts to Detect Deserialization Vulnerabilities

To reduce false positives and false negatives, the following Zest scripts are crafted to detect specific deserialization vulnerabilities.

#### 1. Standard Java Serialization

**Description**: Detects deserialization of user-supplied data using `ObjectInputStream`.

**Zest Script**:
```json
{
  "statement": {
    "statements": [
      {
        "action": {
          "elementType": "ZestRequest",
          "method": "POST",
          "url": "http://targetapp.com/endpoint",
          "data": "serializedObject=<base64_encoded_exploit>"
        }
      },
      {
        "condition": {
          "elementType": "ZestConditionRegex",
          "regex": "java.io.InvalidClassException",
          "location": "RESPONSE_BODY"
        },
        "ifStatements": [
          {
            "elementType": "ZestActionFail",
            "message": "Deserialization vulnerability detected in POST /endpoint",
            "index": 1
          }
        ]
      }
    ],
    "elementType": "ZestScript"
  }
}
```

#### 2. Serialized Data in HTTP Requests

**Description**: Detects deserialization of untrusted serialized objects via an HTTP POST request.

**Zest Script**:
```json
{
  "statement": {
    "statements": [
      {
        "action": {
          "elementType": "ZestRequest",
          "method": "POST",
          "url": "http://targetapp.com/login",
          "data": "auth=serializedObject=<base64_encoded_exploit>"
        }
      },
      {
        "condition": {
          "elementType": "ZestConditionRegex",
          "regex": "java.io.StreamCorruptedException",
          "location": "RESPONSE_BODY"
        },
        "ifStatements": [
          {
            "elementType": "ZestActionFail",
            "message": "Deserialization vulnerability detected in POST /login",
            "index": 2
          }
        ]
      }
    ],
    "elementType": "ZestScript"
  }
}
```

#### 3. Spring Framework

**Description**: Detects deserialization issues within a Spring application, particularly in session or HTTP request handling.

**Zest Script**:
```json
{
  "statement": {
    "statements": [
      {
        "action": {
          "elementType": "ZestRequest",
          "method": "POST",
          "url": "http://targetapp.com/springSession",
          "data": "session=<base64_encoded_exploit>"
        }
      },
      {
        "condition": {
          "elementType": "ZestConditionRegex",
          "regex": "org.springframework.beans.BeanInstantiationException",
          "location": "RESPONSE_BODY"
        },
        "ifStatements": [
          {
            "elementType": "ZestActionFail",
            "message": "Deserialization vulnerability detected in Spring session management",
            "index": 3
          }
        ]
      }
    ],
    "elementType": "ZestScript"
  }
}
```

#### 4. Apache Struts

**Description**: Detects deserialization vulnerabilities tied to Struts forms and request handlers.

**Zest Script**:
```json
{
  "statement": {
    "statements": [
      {
        "action": {
          "elementType": "ZestRequest",
          "method": "POST",
          "url": "http://targetapp.com/strutsAction",
          "data": "formField=<base64_encoded_exploit>"
        }
      },
      {
        "condition": {
          "elementType": "ZestConditionRegex",
          "regex": "com.opensymphony.xwork2.AbstractActionError",
          "location": "RESPONSE_BODY"
        },
        "ifStatements": [
          {
            "elementType": "ZestActionFail",
            "message": "Deserialization vulnerability detected in Struts form handling",
            "index": 4
          }
        ]
      }
    ],
    "elementType": "ZestScript"
  }
}
```

#### 5. Hibernate ORM

**Description**: Focuses on detecting deserialization vulnerabilities within Hibernate's object handling and complex query processing.

**Zest Script**:
```json
{
  "statement": {
    "statements": [
      {
        "action": {
          "elementType": "ZestRequest",
          "method": "POST",
          "url": "http://targetapp.com/hibernateQuery",
          "data": "query=<base64_encoded_exploit>"
        }
      },
      {
        "condition": {
          "elementType": "ZestConditionRegex",
          "regex": "org.hibernate.QueryException",
          "location": "RESPONSE_BODY"
        },
        "ifStatements": [
          {
            "elementType": "ZestActionFail",
            "message": "Deserialization vulnerability detected in Hibernate query processing",
            "index": 5
          }
        ]
      }
    ],
    "elementType": "ZestScript"
  }
}
```

### Conclusion

These Zest scripts aim to detect deserialization vulnerabilities in different contexts and frameworks within Java web applications. By focusing on specific error messages and behaviors, these scripts help to minimize false positives and false negatives, providing more accurate detection of potential security issues. 

**References**:
- Key concepts and scripting examples were based on provided Zest scripting documentation  .
- Deserialization of untrusted data concepts and detailed recommendations referenced from collected knowledge  .