# Improper Neutralization of Special Elements used in an Expression Language Statement ('Expression Language Injection') (CWE-917) in Java

###### Improper Neutralization of Special Elements used in an Expression Language Statement ('Expression Language Injection')

**Definition:**
Expression Language Injection occurs when user input is evaluated in the server-side Expression Language (EL) interpreter. If input is not properly sanitized or escapes special characters, malicious expressions can be executed, leading to unauthorized actions, data exposures, or arbitrary code execution on the server.

### Variations of Expression Language Injection in Java Frameworks

1. **JSP (JavaServer Pages):**
   - JSP is a common technology used for server-side rendering where EL is often embedded within templates.
   - **Example Vulnerability:** Using user input in EL without proper sanitization.

2. **Spring Framework:**
   - Spring employs EL (e.g., SpEL) in templates used by Spring MVC, Spring Boot, among others.
   - **Example Vulnerability:** Directly using unsanitized user input in controller views.

3. **JSF (JavaServer Faces):**
   - JSF integrates EL in the form of managed beans and facelets to bind component values easily.
   - **Example Vulnerability:** Unescaped user input directly managed by JSF components can lead to EL injection when rendering views.

### OWASP ZAP Zest Scripts to Detect Expression Language Injection in Various Java Frameworks

To keep false positives and negatives to a minimum, the ZAP scripting should include both generic payloads and framework-specific checks. Below are sample Zest scripts for each framework:

#### 1. **JSP Injection Detection Script:**

```json
{
  "title": "JSP EL Injection Test",
  "description": "Detect EL Injection vulnerabilities in JSP pages.",
  "elements": [
    {
      "elementType": "ZestRequest",
      "url": "http://example.com/search?query=${7*7}",
      "method": "GET",
      "headers": "",
      "index": 1
    },
    {
      "elementType": "ZestAssertion",
      "rootExpression": {
        "elementType": "ZestExpressionStatusCode",
        "code": 200,
        "not": false
      }
    },
    {
      "elementType": "ZestConditionRegex",
      "regex": "49",
      "location": "BODY",
      "ifStatements": [
        {
          "elementType": "ZestActionFail",
          "message": "EL injection detected in JSP."
        }
      ],
      "elseStatements": []
    }
  ]
}
```

#### 2. **Spring Framework (Spring MVC) Injection Detection Script:**

```json
{
  "title": "Spring EL Injection Test",
  "description": "Detect EL Injection vulnerabilities in Spring MVC applications.",
  "elements": [
    {
      "elementType": "ZestRequest",
      "url": "http://example.com/search?query=${7*7}",
      "method": "GET",
      "headers": "",
      "index": 1
    },
    {
      "elementType": "ZestAssertion",
      "rootExpression": {
        "elementType": "ZestExpressionStatusCode",
        "code": 200,
        "not": false
      }
    },
    {
      "elementType": "ZestConditionRegex",
      "regex": "49",
      "location": "BODY",
      "ifStatements": [
        {
          "elementType": "ZestActionFail",
          "message": "EL injection detected in Spring MVC."
        }
      ],
      "elseStatements": []
    }
  ]
}
```

#### 3. **JSF Injection Detection Script:**

```json
{
  "title": "JSF EL Injection Test",
  "description": "Detect EL Injection vulnerabilities in JSF applications.",
  "elements": [
    {
      "elementType": "ZestRequest",
      "url": "http://example.com/search.xhtml?query=#{7*7}",
      "method": "GET",
      "headers": "",
      "index": 1
    },
    {
      "elementType": "ZestAssertion",
      "rootExpression": {
        "elementType": "ZestExpressionStatusCode",
        "code": 200,
        "not": false
      }
    },
    {
      "elementType": "ZestConditionRegex",
      "regex": "49",
      "location": "BODY",
      "ifStatements": [
        {
          "elementType": "ZestActionFail",
          "message": "EL injection detected in JSF."
        }
      ],
      "elseStatements": []
    }
  ]
}
```

### Conclusion

Performing Expression Language Injection testing on web applications written in Java frameworks such as JSP, Spring MVC, and JSF involves exploiting the manner in which EL interprets and processes user inputs. The provided Zest scripts can automate the detection of such vulnerabilities by introducing common EL injection payloads and asserting the presence of the computed expressions in the responses.

### References
- WSTG - Web Security Testing Guide: Various Techniques for identifying and exploiting EL Injections【4:0†source】  .
- Zest Scripting Documentation - Leveraging ZAP for writing effective Zest scripts and assertions .