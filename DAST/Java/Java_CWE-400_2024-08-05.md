# Uncontrolled Resource Consumption (CWE-400) in Java

###### Understanding Uncontrolled Resource Consumption

**Uncontrolled Resource Consumption**, also known as "Resource Exhaustion," occurs when an application cannot adequately manage resources, such as memory, CPU, file handles, or network bandwidth. This vulnerability can be exploited by attackers to deplete the application’s resources, leading to performance degradation or denial of service (DoS).

### Variations of Uncontrolled Resource Consumption in Java Web Applications

Uncontrolled Resource Consumption can manifest in various ways in Java web applications across different frameworks like Spring, Hibernate, and Java EE. Here are some common scenarios:

1. **Memory Leaks**: Occurs when the application fails to release memory that’s no longer needed, leading to out-of-memory (OOM) errors.
   
2. **CPU Starvation**: Happens when computation-heavy operations are triggered, consuming excessive CPU resources.
   
3. **File Handle Leakage**: Arises when file handles are not properly closed, exhausting the system’s file descriptor limit.
   
4. **Thread Exhaustion**: Happens when the application spawns too many threads without proper control, consuming all available threads in the pool.
   
5. **Database Connection Leakage**: Occurs when database connections are not properly closed, leading to exhaustion of the connection pool.

### Detecting Uncontrolled Resource Consumption Using OWASP ZAP Zest Scripts

#### 1. **Memory Leak Detection**

A Zest script for uncontrolled memory usage attempts to trigger high memory consumption via inputs designed to cause the application to allocate large amounts of memory. 

```json
{
  "title": "Memory Leak Test",
  "description": "Check for memory leaks.",
  "statements": [
    {
      "index": 1,
      "elementType": "ZestRequest",
      "url": "http://localhost:8080/resource-intense",
      "method": "GET"
    },
    {
      "index": 2,
      "elementType": "ZestConditionResponseTime",
      "time": 10000,  // 10 seconds
      "greater": true,
      "ifStatements": [
        {
          "index": 3,
          "elementType": "ZestActionFail",
          "message": "Potential memory leak detected: response time exceeded 10 seconds."
        }
      ]
    }
  ]
}
```

#### 2. **CPU Starvation Detection**

This Zest script tests for CPU starvation by sending multiple requests designed to trigger heavy computation.

```json
{
  "title": "CPU Starvation Test",
  "description": "Check for CPU intensive operations leading to starvation.",
  "statements": [
    {
      "index": 1,
      "elementType": "ZestRequest",
      "url": "http://localhost:8080/cpu-intensive",
      "method": "GET"
    },
    {
      "index": 2,
      "elementType": "ZestActionRepeat",
      "times": 100,  // Send 100 requests to test CPU handling
      "statements": [
        {
          "index": 3,
          "elementType": "ZestConditionResponseTime",
          "time": 1000,  // 1 second
          "greater": true,
          "ifStatements": [
            {
              "index": 4,
              "elementType": "ZestActionFail",
              "message": "Potential CPU starvation detected: response time exceeded 1 second."
            }
          ]
        }
      ]
    }
  ]
}
```

#### 3. **File Handle Leak Detection**

A Zest script for uncontrolled file handle usage attempts to access resources repeatedly to deplete available file handles.

```json
{
  "title": "File Handle Leak Test",
  "description": "Check for file handle leaks.",
  "statements": [
    {
      "index": 1,
      "elementType": "ZestRequest",
      "url": "http://localhost:8080/file-access",
      "method": "GET"
    },
    {
      "index": 2,
      "elementType": "ZestActionRepeat",
      "times": 5000,  // Open 5000 files to test handle usage
      "statements": [
        {
          "index": 3,
          "elementType": "ZestConditionResponseTime",
          "time": 5000,  // 5 seconds
          "greater": true,
          "ifStatements": [
            {
              "index": 4,
              "elementType": "ZestActionFail",
              "message": "Potential file handle leak detected: response time exceeded 5 seconds."
            }
          ]
        }
      ]
    }
  ]
}
```

#### 4. **Thread Exhaustion Detection**

This Zest script for uncontrolled thread creation attempts to trigger the creation of a large number of threads.

```json
{
  "title": "Thread Exhaustion Test",
  "description": "Check for thread exhaustion scenarios.",
  "statements": [
    {
      "index": 1,
      "elementType": "ZestRequest",
      "url": "http://localhost:8080/thread-intensive",
      "method": "GET"
    },
    {
      "index": 2,
      "elementType": "ZestActionRepeat",
      "times": 1000,  // Trigger 1000 thread-intensive operations
      "statements": [
        {
          "index": 3,
          "elementType": "ZestConditionResponseTime",
          "time": 10000,  // 10 seconds
          "greater": true,
          "ifStatements": [
            {
              "index": 4,
              "elementType": "ZestActionFail",
              "message": "Potential thread exhaustion detected: response time exceeded 10 seconds."
            }
          ]
        }
      ]
    }
  ]
}
```

#### 5. **Database Connection Leak Detection**

This script checks for database connection leaks by making repeated database access requests.

```json
{
  "title": "Database Connection Leak Test",
  "description": "Check for database connection leaks.",
  "statements": [
    {
      "index": 1,
      "elementType": "ZestRequest",
      "url": "http://localhost:8080/db-access",
      "method": "GET"
    },
    {
      "index": 2,
      "elementType": "ZestActionRepeat",
      "times": 2000,  // Make 2000 database requests
      "statements": [
        {
          "index": 3,
          "elementType": "ZestConditionResponseTime",
          "time": 5000,  // 5 seconds
          "greater": true,
          "ifStatements": [
            {
              "index": 4,
              "elementType": "ZestActionFail",
              "message": "Potential database connection leak detected: response time exceeded 5 seconds."
            }
          ]
        }
      ]
    }
  ]
}
```

### Conclusion

Each of these Zest scripts aims to detect specific types of uncontrolled resource consumption in Java web applications. By simulating various forms of stress on the application, these scripts can help identify areas where resource management needs improvement, reducing the risk of Denial of Service (DoS) attacks    .