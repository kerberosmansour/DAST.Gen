# Server-Side Request Forgery (SSRF) (CWE-918) in PHP

###### What is Server-Side Request Forgery (SSRF)?

Server-Side Request Forgery (SSRF) is a type of vulnerability where an attacker can manipulate a server-side application to make HTTP requests to an arbitrary domain chosen by the attacker. SSRF can be leveraged by attackers to access or manipulate internal services, bypass firewall rules, and potentially exploit internal bugs and vulnerabilities that are not exposed to the external network. SSRF vulnerabilities arise when an application does not validate or sanitize user-controlled input which is used to construct requests to other resources.

Typical impacts of SSRF attacks include:
1. **Internal System Access**: Attacking internal infrastructure by sending requests to internal services that are not publicly accessible.
2. **Data Exfiltration**: Extracting internal data from the web application.
3. **Remote Code Execution (RCE)**: Exploiting vulnerable services reachable internally to execute code on the server.
4. **Metadata API Access**: Gaining access to cloud metadata APIs, which can lead to data theft or taking over cloud instances.

## Variations of SSRF in PHP Web Applications

### 1. Direct URL Input
Direct URL input vulnerabilities occur when a web application accepts a URL as user input and does not perform proper validation or sanitization. 

#### Example:
A common example is when user input is used to fetch remote content:
```php
$content = file_get_contents($_GET['url']);
echo $content;
```

#### Detection Script (OWASP ZAP Zest):
```json
{
  "description": "Test for SSRF in direct URL input",
  "requests": [
    {
      "method": "GET",
      "url": "http://example.com?url=http://127.0.0.1/admin",
      "assertions": [
        { "equals": { "statusCode": 200 } }
      ]
    },
    {
      "method": "GET",
      "url": "http://example.com?url=https://malicioussite.com",
      "assertions": [
        { "equals": { "statusCode": 200 } }
      ]
    }
  ]
}
```

### 2. URL Redirection
SSRF vulnerabilities can also be introduced through open redirects, where an attacker manipulates a URL parameter to redirect the server to make a request to an unintended location.

#### Example:
```php
header("Location: " . $_GET['url']);
exit();
```

#### Detection Script (OWASP ZAP Zest):
```json
{
  "description": "Test for SSRF in URL redirection",
  "requests": [
    {
      "method": "GET",
      "url": "http://example.com/redirect.php?url=http://127.0.0.1/admin",
      "assertions": [
        { "equals": { "statusCode": 200 } }
      ]
    },
    {
      "method": "GET",
      "url": "http://example.com/redirect.php?url=https://malicioussite.com",
      "assertions": [
        { "equals": { "statusCode": 200 } }
      ]
    }
  ]
}
```

### 3. SSRF via PDF Generation
PDF generation libraries often accept URLs to fetch content that is rendered into a PDF. An attacker can leverage this to make the server fetch internal URLs.

#### Example:
```php
require_once("dompdf/dompdf_config.inc.php");
$dompdf = new DOMPDF();
$dompdf->load_html_file($_GET['url']);
$dompdf->render();
$dompdf->stream("sample.pdf");
```

#### Detection Script (OWASP ZAP Zest):
```json
{
  "description": "Test for SSRF in PDF generation",
  "requests": [
    {
      "method": "GET",
      "url": "http://example.com/generate_pdf.php?url=http://127.0.0.1/admin",
      "assertions": [
        { "equals": { "statusCode": 200 } }
      ]
    },
    {
      "method": "GET",
      "url": "http://example.com/generate_pdf.php?url=https://malicioussite.com",
      "assertions": [
        { "equals": { "statusCode": 200 } }
      ]
    }
  ]
}
```

### References

This information is based on the Server-Side Request Forgery testing guidelines in the OWASP Web Security Testing Guide:
- [WSTG - Testing for Server-Side Request Forgery](https://github.com/OWASP/wstg/tree/master/documentation/4-Web_Application_Security_Testing/07-Input_Validation_Testing/18-Testing_for_Server_Side_Request_Forgery)【4:0†source】.